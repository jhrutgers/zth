<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zth (libzth): Using Zth on Bare-Metal ARM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zth (libzth)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_examples_arm__r_e_a_d_m_e-_a_r_m.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Using Zth on Bare-Metal ARM </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>There is preliminary support for bare-metal ARM with Zth. Most of Zth's source code is just C++, so usable on any target. Only the context switching and hardware-related stuff like <code>clock_gettime()</code> is to be ported.</p>
<p>The directory <code>examples/arm</code> contains a set of files that shows how to do this. This examples targets a Qemu virt machine to run the examples. This virt machine uses an ARM Cortex-A15 with VFP (without NEON). The implementation is not very nice, but shows you where to start, if you have your own ARM system. The compiler, linker script, and startup files are probably supplied to you by the manufacturer of your board.</p>
<p>To get the stuff running, do this:</p>
<ol type="1">
<li>Create an out-of-tree build directory, just like normal: <pre class="fragment"> mkdir build-arm
 cd build-arm
 cmake ..
</pre></li>
<li><p class="startli">Now, cross-compile all examples in one go. The files will be generated in the directory <code>examples/arm/zth-arm/examples</code>. </p><pre class="fragment">cd build-arm
make arm
</pre><p class="startli">That was easy! Ok, I was cheating a bit. This actually happened (see also <code>examples/arm/CMakeLists.txt</code>):</p><ol type="a">
<li>Download and extract ARM toolchain (<code>arm-none-eabi-gcc</code> and friends). The toolchain is installed in <code>examples/arm/gcc-arm-none...</code> <pre class="fragment">make arm-none-eabi-gcc
</pre></li>
<li>Download, extract and build <code>newlib</code>. This uses the toolchain, as installed in the previous step. <code>newlib</code> is compiled specifically for our target processor. <pre class="fragment">make arm-newlib
</pre></li>
<li>Build BSP (<code>libarm-bsp.a</code>). This library contains <code>crt0.c</code> and <code>startup.S</code>, which both reside in <code>examples/arm</code>. These files include the interrupt vector for the ARM, intialization of the VFP, C/C++-runtime boot code, and the system calls that <code>newlib</code> needs, like <code>_read()</code> and <code>_write()</code>. All binaries compiled for our target need this BSP library further on. <pre class="fragment">make arm-bsp
</pre></li>
<li>A new CMake out-of-tree build is initiated with the propert toolchain configuration. Basically, this calls CMake with <code>-DCMAKE_TOOLCHAIN_FILE=examples/arm/toolchain.cmake</code> in the directory <code>examples/arm/zth-arm</code>. <pre class="fragment">make zth-arm
</pre></li>
<li>Build Zth for ARM. This target includes everything above, but also runs <code>make</code> in <code>examples/arm/zth-arm</code>. As a result, all examples are cross-compiled for ARM in <code>examples/arm/zth-arm/examples</code>. The examples are built using the <code>toolchain.cmake</code> configuration, as provided above, and are linked against our <code>newlib</code> and <code>libarm-bsp.a</code>. <pre class="fragment">make arm
</pre></li>
</ol>
</li>
<li><p class="startli">Run Qemu with one of the examples. I have tested it with Qemu 3.0.0. (Note: Press 'Ctrl-A X' to terminate Qemu) </p><pre class="fragment">qemu-system-arm -machine virt -cpu cortex-a15 -s -m 8M -nographic -kernel examples/arm/zth-arm/examples/1_helloworld
</pre><p class="startli">If you have a debug build, the output will include the banner, saying something like: </p><pre class="fragment">&gt; zth::banner: Zth 0.1.0 g++-8.3.1 C++14 baremetal newlib3.1.0 arm debug sjlj
</pre><p class="startli">Note that there is no OS that supplies <code><a class="el" href="namespacezth.html#a043bfb5a7c98cdceb7c9386837ca466d">poll()</a></code>. So reading stdin is a bit tricky and not all examples behave the same way as at your PC. Moreover, 0MQ isn't available either, of course.</p>
</li>
<li>Connect <code>gdb</code> to Qemu. If you supply the <code>-S</code> argument to Qemu, it waits for <code>gdb</code> to connect before it starts. That might make debugging a bit easier. <pre class="fragment">examples/arm/gcc-arm-none-eabi-8-2019-q3-update/bin/arm-none-eabi-gdb -ex 'target remote :1234' -ex 'break main' -ex 'layout split' examples/arm/zth-arm/examples/1_helloworld
</pre> </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
