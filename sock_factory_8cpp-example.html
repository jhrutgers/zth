<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zth (libzth): sock_factory.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Zth (libzth)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('sock_factory_8cpp-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">sock_factory.cpp</div></div>
</div><!--header-->
<div class="contents">
<p>More complex coroutine example.</p>
<p>More complex coroutine example.This program will print something like this:</p>
<pre class="fragment">Fiber factory: creating 7.42921 of fiber
Fiber factory: creating 8.33466 of fiber
Fiber factory: creating 4.19363 of fiber
   Got 15.7639 of fiber, creating sock 1 (12.5)
Fiber factory: creating 8.79472 of fiber
   Waste collector: collected 3.26387 of waste (total 3.26387)
Fiber factory: creating 6.06279 of fiber
Fiber factory: creating 8.04504 of fiber
   Got 10.2564 of fiber, creating sock 2 (5)
   Waste collector: collected 5.25642 of waste (total 8.5203)
Fiber factory: creating 2.31155 of fiber
   Got 16.8398 of fiber, creating sock 3 (12.5)
Fiber factory: creating 5.54631 of fiber
   Waste collector: collected 4.33976 of waste (total 12.8601)
Fiber factory: creating 3.57323 of fiber
Fiber factory: creating 7.32052 of fiber
   Got 5.88478 of fiber, creating sock 4 (5)
   Waste collector: collected 0.884785 of waste (total 13.7448)
Fiber factory: creating 5.92226 of fiber
      Packing facility: packed set 1 with sock 1 (12.5), sock 3 (12.5), sock 2 (5), and sock 4 (5)
   Got 12.8668 of fiber, creating sock 5 (12.5)
Fiber factory: creating 4.20885 of fiber
   Waste collector: collected 0.366831 of waste (total 14.1117)
   Got 5.92226 of fiber, creating sock 6 (5)
   Waste collector: collected 0.922256 of waste (total 15.0339)
Fiber factory: creating 4.09638 of fiber
Fiber factory: creating 8.35822 of fiber
Fiber factory: creating 2.49278 of fiber
   Got 12.5671 of fiber, creating sock 7 (12.5)
Fiber factory: creating 9.02039 of fiber
   Waste collector: collected 0.0670719 of waste (total 15.101)
   Got 6.58916 of fiber, creating sock 8 (5)
   Waste collector: collected 1.58916 of waste (total 16.6902)
Fiber factory: creating 1.02409 of fiber
      Packing facility: packed set 2 with sock 5 (12.5), sock 7 (12.5), sock 6 (5), and sock 8 (5)
Fiber factory: creating 3.43832 of fiber
Fiber factory: no more fiber to create
</pre><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * SPDX-FileCopyrightText: 2019-2026 Jochem Rutgers</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * SPDX-License-Identifier: CC0-1.0</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// This example shows how to use C++20 coroutines in Zth.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="zth.html">zth</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;random&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a id="_a0" name="_a0"></a><a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;float&gt;</a> fiber_factory(<span class="keywordtype">float</span> supply)</div>
<div class="line">{</div>
<div class="line">        <span class="comment">// NOLINTNEXTLINE</span></div>
<div class="line">        std::mt19937 gen{(unsigned)time(<span class="keyword">nullptr</span>)};</div>
<div class="line">        std::uniform_real_distribution&lt;float&gt; distrib{1, 10};</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span>(supply &gt; 0) {</div>
<div class="line">                <span class="keywordtype">float</span> x = std::min(supply, distrib(gen));</div>
<div class="line">                printf(<span class="stringliteral">&quot;Fiber factory: creating %g of fiber\n&quot;</span>, (<span class="keywordtype">double</span>)x);</div>
<div class="line">                <span class="keyword">co_yield</span> x;</div>
<div class="line">                supply -= x;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Fiber factory: no more fiber to create\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Sock {</div>
<div class="line">        <span class="keyword">explicit</span> Sock(<span class="keywordtype">float</span> material_used_)</div>
<div class="line">                : str{<a class="code hl_namespace" href="namespacezth.html">zth</a>::format(<span class="stringliteral">&quot;sock %d (%g)&quot;</span>, ++id_next, (double)material_used_)}</div>
<div class="line">                , material_used{material_used_}</div>
<div class="line">        {}</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> id_next = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_typedef" href="group__zth__api__cpp__util.html#ga7a210137c60a4a060f81aeb19a9394c0">zth::string</a> <a class="code hl_function" href="namespacezth.html#a3d3d928f0db6f76bfd4d414d5ed2e2e8">str</a>;</div>
<div class="line">        <span class="keywordtype">float</span> material_used;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;Sock, float&gt;</a></div>
<div class="line">sock_factory(<a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;float&gt;</a> fiber_generator, <span class="keywordtype">float</span> amount_of_fiber)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div>
<div class="line">                <span class="keywordtype">float</span> got_fiber = 0;</div>
<div class="line">                <span class="keywordflow">while</span>(got_fiber &lt; amount_of_fiber)</div>
<div class="line">                        got_fiber += <span class="keyword">co_await</span> fiber_generator;</div>
<div class="line"> </div>
<div class="line">                Sock s{amount_of_fiber};</div>
<div class="line">                printf(<span class="stringliteral">&quot;   Got %g of fiber, creating %s\n&quot;</span>, (<span class="keywordtype">double</span>)got_fiber, s.str.c_str());</div>
<div class="line">                <span class="keyword">co_yield</span> s;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span>(got_fiber &gt; amount_of_fiber)</div>
<div class="line">                        <span class="keyword">co_yield</span> got_fiber - amount_of_fiber; <span class="comment">// waste</span></div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a id="_a1" name="_a1"></a><a class="code hl_class" href="classzth_1_1coro_1_1task.html">zth::coro::task&lt;int&gt;</a></div>
<div class="line">packing_socks(<a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;Sock, float&gt;</a> big, <a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;Sock, float&gt;</a> small)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordtype">int</span> sets = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div>
<div class="line">                        Sock big_left = <span class="keyword">co_await</span> big.<a id="a2" name="a2"></a><a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a706f09e29fd976e68607ac5fe49e551b">as</a>&lt;Sock&gt;();</div>
<div class="line">                        Sock big_right = <span class="keyword">co_await</span> big.<a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a706f09e29fd976e68607ac5fe49e551b">as</a>&lt;Sock&gt;();</div>
<div class="line">                        Sock small_left = <span class="keyword">co_await</span> small.<a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a706f09e29fd976e68607ac5fe49e551b">as</a>&lt;Sock&gt;();</div>
<div class="line">                        Sock small_right = <span class="keyword">co_await</span> small.<a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a706f09e29fd976e68607ac5fe49e551b">as</a>&lt;Sock&gt;();</div>
<div class="line">                        printf(<span class="stringliteral">&quot;      Packing facility: packed set %d with %s, %s, %s, and %s\n&quot;</span>,</div>
<div class="line">                               ++sets, big_left.str.c_str(), big_right.str.c_str(),</div>
<div class="line">                               small_left.str.c_str(), small_right.str.c_str());</div>
<div class="line">                }</div>
<div class="line">        } <span class="keywordflow">catch</span>(<a id="_a3" name="_a3"></a><a class="code hl_struct" href="structzth_1_1coro__already__completed.html">zth::coro_already_completed</a> <span class="keyword">const</span>&amp;) {</div>
<div class="line">                <span class="comment">// Dispose socks in the pipeline.</span></div>
<div class="line">                <span class="keywordflow">if</span>(big.<a id="a4" name="a4"></a><a class="code hl_function" href="classzth_1_1coro_1_1generator.html#ab34dd9773190b93460b062e10fdac596">valid</a>&lt;Sock&gt;())</div>
<div class="line">                        big.<a id="a5" name="a5"></a><a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a8b1db406cdd06812a4d28aff37dcc3d3">value</a>&lt;Sock&gt;();</div>
<div class="line">                <span class="keywordflow">if</span>(small.<a class="code hl_function" href="classzth_1_1coro_1_1generator.html#ab34dd9773190b93460b062e10fdac596">valid</a>&lt;Sock&gt;())</div>
<div class="line">                        small.<a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a8b1db406cdd06812a4d28aff37dcc3d3">value</a>&lt;Sock&gt;();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">co_return</span> sets;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a id="a6" name="a6"></a><a class="code hl_function" href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordtype">float</span> supply = 100.F;</div>
<div class="line">        <span class="keywordflow">if</span>(argc &gt; 1)</div>
<div class="line">                supply = (float)strtol(argv[1], <span class="keyword">nullptr</span>, 10);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> fiber_generator = fiber_factory(supply);</div>
<div class="line">        fiber_generator.<a id="a7" name="a7"></a><a class="code hl_function" href="classzth_1_1coro_1_1generator.html#a120eade114be4553934b259d84d9088e">fiber</a>(<span class="stringliteral">&quot;fiber factory&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> big_sock_factory = sock_factory(fiber_generator, 12.5F);</div>
<div class="line">        big_sock_factory.fiber(<span class="stringliteral">&quot;big sock factory&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> small_sock_factory = sock_factory(fiber_generator, 5.F);</div>
<div class="line">        small_sock_factory.setName(<span class="stringliteral">&quot;small sock factory&quot;</span>);</div>
<div class="line">        <span class="comment">// The small sock factory is so small, it does not need its own fiber.</span></div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> waste_collector = [](<a class="code hl_class" href="classzth_1_1coro_1_1generator.html">zth::coro::generator&lt;Sock, float&gt;</a> g) -&gt; <a class="code hl_class" href="classzth_1_1coro_1_1task.html">zth::coro::task&lt;float&gt;</a> {</div>
<div class="line">                <span class="keyword">static</span> <span class="keywordtype">float</span> total_waste = 0.F;</div>
<div class="line">                <span class="keywordflow">while</span>(<span class="keyword">true</span>) {</div>
<div class="line">                        <span class="keywordtype">float</span> waste = <span class="keyword">co_await</span> g.as&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">                        total_waste += waste;</div>
<div class="line">                        printf(<span class="stringliteral">&quot;   Waste collector: collected %g of waste (total %g)\n&quot;</span>,</div>
<div class="line">                               (<span class="keywordtype">double</span>)waste, (<span class="keywordtype">double</span>)total_waste);</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">co_return</span> total_waste;</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        zth::join(</div>
<div class="line">                waste_collector(big_sock_factory).<a class="code hl_function" href="group__zth__api__cpp__fiber.html#ga726ffb960e201a580e3ee6c82bf3a5e1">fiber</a>(<span class="stringliteral">&quot;waste collector 1&quot;</span>),</div>
<div class="line">                waste_collector(small_sock_factory).<a class="code hl_function" href="group__zth__api__cpp__fiber.html#ga726ffb960e201a580e3ee6c82bf3a5e1">fiber</a>(<span class="stringliteral">&quot;waste collector 2&quot;</span>),</div>
<div class="line">                packing_socks(big_sock_factory, small_sock_factory).<a class="code hl_function" href="group__zth__api__cpp__fiber.html#ga726ffb960e201a580e3ee6c82bf3a5e1">fiber</a>(<span class="stringliteral">&quot;packing facility&quot;</span>));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclasszth_1_1coro_1_1generator_html"><div class="ttname"><a href="classzth_1_1coro_1_1generator.html">zth::coro::generator</a></div><div class="ttdoc">A coroutine generator producing a sequence of values.</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l00904">coro.h:904</a></div></div>
<div class="ttc" id="aclasszth_1_1coro_1_1generator_html_a120eade114be4553934b259d84d9088e"><div class="ttname"><a href="classzth_1_1coro_1_1generator.html#a120eade114be4553934b259d84d9088e">zth::coro::generator::fiber</a></div><div class="ttdeci">decltype(auto) fiber(char const *name=nullptr)</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l01010">coro.h:1010</a></div></div>
<div class="ttc" id="aclasszth_1_1coro_1_1generator_html_a706f09e29fd976e68607ac5fe49e551b"><div class="ttname"><a href="classzth_1_1coro_1_1generator.html#a706f09e29fd976e68607ac5fe49e551b">zth::coro::generator::as</a></div><div class="ttdeci">decltype(auto) as() const</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l00960">coro.h:960</a></div></div>
<div class="ttc" id="aclasszth_1_1coro_1_1generator_html_a8b1db406cdd06812a4d28aff37dcc3d3"><div class="ttname"><a href="classzth_1_1coro_1_1generator.html#a8b1db406cdd06812a4d28aff37dcc3d3">zth::coro::generator::value</a></div><div class="ttdeci">decltype(auto) value()</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l00973">coro.h:973</a></div></div>
<div class="ttc" id="aclasszth_1_1coro_1_1generator_html_ab34dd9773190b93460b062e10fdac596"><div class="ttname"><a href="classzth_1_1coro_1_1generator.html#ab34dd9773190b93460b062e10fdac596">zth::coro::generator::valid</a></div><div class="ttdeci">bool valid() const noexcept</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l00966">coro.h:966</a></div></div>
<div class="ttc" id="aclasszth_1_1coro_1_1task_html"><div class="ttname"><a href="classzth_1_1coro_1_1task.html">zth::coro::task</a></div><div class="ttdoc">A coroutine task producing a single result value.</div><div class="ttdef"><b>Definition</b> <a href="coro_8h_source.html#l00515">coro.h:515</a></div></div>
<div class="ttc" id="afiber_8h_html_ac8d3574f284314abb573cdb5762eaf94"><div class="ttname"><a href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a></div><div class="ttdeci">int main_fiber(int argc, char **argv)</div><div class="ttdef"><b>Definition</b> <a href="main_8cpp_source.html#l00011">main.cpp:11</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_ga726ffb960e201a580e3ee6c82bf3a5e1"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#ga726ffb960e201a580e3ee6c82bf3a5e1">zth::fiber</a></div><div class="ttdeci">fiber_type&lt; F &gt;::fiber fiber(F &amp;&amp;f, Args &amp;&amp;... args)</div><div class="ttdoc">Create and start a new fiber.</div><div class="ttdef"><b>Definition</b> <a href="async_8h_source.html#l01192">async.h:1192</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__util_html_ga7a210137c60a4a060f81aeb19a9394c0"><div class="ttname"><a href="group__zth__api__cpp__util.html#ga7a210137c60a4a060f81aeb19a9394c0">zth::string</a></div><div class="ttdeci">std::basic_string&lt; char, std::char_traits&lt; char &gt;, Config::Allocator&lt; char &gt;::type &gt; string</div><div class="ttdoc">std::string type using Config::Allocator::type.</div><div class="ttdef"><b>Definition</b> <a href="util_8h_source.html#l00315">util.h:315</a></div></div>
<div class="ttc" id="anamespacezth_html"><div class="ttname"><a href="namespacezth.html">zth</a></div><div class="ttdef"><b>Definition</b> <a href="allocator_8h_source.html#l00022">allocator.h:22</a></div></div>
<div class="ttc" id="anamespacezth_html_a3d3d928f0db6f76bfd4d414d5ed2e2e8"><div class="ttname"><a href="namespacezth.html#a3d3d928f0db6f76bfd4d414d5ed2e2e8">zth::str</a></div><div class="ttdeci">cow_string str(T value)</div><div class="ttdoc">Returns an zth::string representation of the given value.</div><div class="ttdef"><b>Definition</b> <a href="util_8h_source.html#l00497">util.h:497</a></div></div>
<div class="ttc" id="astructzth_1_1coro__already__completed_html"><div class="ttname"><a href="structzth_1_1coro__already__completed.html">zth::coro_already_completed</a></div><div class="ttdoc">Exception thrown when a coroutine has already completed.</div><div class="ttdef"><b>Definition</b> <a href="exception_8h_source.html#l00036">exception.h:36</a></div></div>
<div class="ttc" id="azth_html"><div class="ttname"><a href="zth.html">zth</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
