<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zth (libzth): 2_fibers.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Zth (libzth)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('2_fibers_8cpp-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">2_fibers.cpp</div></div>
</div><!--header-->
<div class="contents">
<p>Fiber creation.</p>
<p>Fiber creation.This program will print:</p>
<pre class="fragment">fiber_vv()
fddd is not valid yet
fiber_ddd(3, 4) = 7
fddd = 7
fiber_ddd(1, 2) = 3
fiber_vii(3, 14)
fiber_vi(42)
fiber_vv()
</pre><p>Note that the order of the last four lines is not deterministic.</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * SPDX-FileCopyrightText: 2019-2026 Jochem Rutgers</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * SPDX-License-Identifier: CC0-1.0</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="zth.html">zth</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// zth_fiber() is used to allow using `zth_async&#39; on a function to start a fiber</span></div>
<div class="line"><span class="comment">// with the given function as entry point.  zth_fiber() generates some static</span></div>
<div class="line"><span class="comment">// variables to implement this. So, don&#39;t use zth_fiber() in a header file, as</span></div>
<div class="line"><span class="comment">// it will result in a linker complaining about multiple symbols. You can split</span></div>
<div class="line"><span class="comment">// zth_fiber() in two parts: the declaration (zth_fiber_declare()) and</span></div>
<div class="line"><span class="comment">// definition (zth_fiber_define()), like you do with most functions in headers</span></div>
<div class="line"><span class="comment">// and source files.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The same applies in case there is a circular dependency between two function</span></div>
<div class="line"><span class="comment">// calling each other as a fiber.  In that case, you can forward declare the</span></div>
<div class="line"><span class="comment">// fiber using zth_fiber_declare(), just like you would do in a header file.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// In case you have a header file that should make fibers visible, declare your</span></div>
<div class="line"><span class="comment">// function as normal.</span></div>
<div class="line"><span class="keywordtype">void</span> fiber_vv();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Then, use zth_fiber_declare() instead of zth_fiber() to generate everything</span></div>
<div class="line"><span class="comment">// that is required such that other compilation units can do `zth_async</span></div>
<div class="line"><span class="comment">// fiber_vv()&#39;.</span></div>
<div class="line"><a id="a0" name="a0"></a><a class="code hl_define" href="group__zth__api__cpp__fiber.html#gaa75c9c194e3894b31f044e0e9d3a8c1d">zth_fiber_declare</a>(fiber_vv)</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In one .cpp file, zth_fiber_define() is required to implement the actual</span></div>
<div class="line"><span class="comment">// fiber creation code.</span></div>
<div class="line"><a id="a1" name="a1"></a><a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga2603bf564dbfe29105402410f898bcde">zth_fiber_define</a>(fiber_vv)</div>
<div class="line"> </div>
<div class="line"><span class="comment">// And, of course, you need to implement the function itself in the .cpp file.</span></div>
<div class="line"><span class="keywordtype">void</span> fiber_vv()</div>
<div class="line">{</div>
<div class="line">        printf(<span class="stringliteral">&quot;fiber_vv()\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// You can use function parameters of any type in the fiber entry function,</span></div>
<div class="line"><span class="comment">// except for references (like an `int const&amp;&#39; parameter).  In the</span></div>
<div class="line"><span class="comment">// implementation, the arguments are stored and given to the Fiber object.</span></div>
<div class="line"><span class="comment">// Reference variables are const, and cannot be reassigned, so this is not</span></div>
<div class="line"><span class="comment">// possible to save and forward arguments. If you do a pass-by-value, note that</span></div>
<div class="line"><span class="comment">// the data might be copied multiple times by Zth before ending up in the fiber</span></div>
<div class="line"><span class="comment">// entry. So, try to avoid to do pass-by-value of large structs (as is always</span></div>
<div class="line"><span class="comment">// smart to avoid in all C/C++ code).</span></div>
<div class="line"><span class="keywordtype">void</span> fiber_vi(<span class="keywordtype">int</span> i)</div>
<div class="line">{</div>
<div class="line">        printf(<span class="stringliteral">&quot;fiber_vi(%d)\n&quot;</span>, i);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> fiber_vii(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)</div>
<div class="line">{</div>
<div class="line">        printf(<span class="stringliteral">&quot;fiber_vii(%d, %d)\n&quot;</span>, x, y);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// zth_fiber_declare(), zth_fiber_define() and zth_fiber() allow a list of</span></div>
<div class="line"><span class="comment">// functions. This is identical to calling zth_fiber...() on every function</span></div>
<div class="line"><span class="comment">// separately.</span></div>
<div class="line"><a id="a2" name="a2"></a><a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_vi, fiber_vii)</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Fibers can return data, like normal functions.</span></div>
<div class="line"><span class="keywordtype">double</span> fiber_ddd(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordtype">double</span> res = a + b;</div>
<div class="line">        printf(<span class="stringliteral">&quot;fiber_ddd(%g, %g) = %g\n&quot;</span>, a, b, res);</div>
<div class="line">        <span class="keywordflow">return</span> res;</div>
<div class="line">}</div>
<div class="line"><a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_ddd)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if __cplusplus &gt;= 201103L</span></div>
<div class="line"><span class="comment">// The current implementation for pre-C++11 only support up to three arguments.</span></div>
<div class="line"><span class="comment">// C++11 and higher support arbitrary number of arguments.</span></div>
<div class="line"><span class="keywordtype">double</span> fiber_ddddi(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> c, <span class="keywordtype">int</span> d)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordtype">double</span> res = a * b + c - d;</div>
<div class="line">        printf(<span class="stringliteral">&quot;fiber_ddddi(%g, %g, %g, %d) = %g\n&quot;</span>, a, b, c, d, res);</div>
<div class="line">        <span class="keywordflow">return</span> res;</div>
<div class="line">}</div>
<div class="line"><a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_ddddi)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a id="a3" name="a3"></a><a class="code hl_function" href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a>(<span class="keywordtype">int</span> <span class="comment">/*argc*/</span>, <span class="keywordtype">char</span>** <span class="comment">/*argv*/</span>)</div>
<div class="line">{</div>
<div class="line">        <span class="comment">// `zth_async&#39; is just like a function call, but its execution is</span></div>
<div class="line">        <span class="comment">// postponed.  Note that the order in which the fibers get initialized</span></div>
<div class="line">        <span class="comment">// or execute is not defined.</span></div>
<div class="line">        <a id="a4" name="a4"></a><a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_vv();</div>
<div class="line">        <a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_vi(42);</div>
<div class="line">        <a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_vii(3, 14);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// The fiber entry points are still available to be called directly.</span></div>
<div class="line">        <span class="comment">// So, the following line just calls fiber_vv() right away. There is no</span></div>
<div class="line">        <span class="comment">// side-effect on fiber_vv() as being marked as fiber entry point.</span></div>
<div class="line">        fiber_vv();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// fiber_ddd() returns a value. If it would be started as below, the</span></div>
<div class="line">        <span class="comment">// return value is just lost, just like what would happen if you would</span></div>
<div class="line">        <span class="comment">// call fiber_ddd() as a normal function without using its return</span></div>
<div class="line">        <span class="comment">// value.</span></div>
<div class="line">        <a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_ddd(1, 2);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// zth_fiber() also defines a &lt;function&gt;_future type, which allows</span></div>
<div class="line">        <span class="comment">// synchronization between fibers. `zth_async&#39; returns this type.</span></div>
<div class="line">        fiber_ddd_future fddd = <a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_ddd(3, 4);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Now, fddd is a (smart) pointer to a Future object. fddd is small and</span></div>
<div class="line">        <span class="comment">// can safely be copied or passed using pass-by-value. It gives a few</span></div>
<div class="line">        <span class="comment">// interesting functions:</span></div>
<div class="line">        <span class="comment">// - poll whether the fiber has finished and the future becomes</span></div>
<div class="line">        <span class="comment">//   therefore valid;</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;fddd is %s\n&quot;</span>, fddd-&gt;valid() ? <span class="stringliteral">&quot;valid&quot;</span> : <span class="stringliteral">&quot;not valid yet&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// - suspend the current fiber and wait until the fiber has finished;</span></div>
<div class="line">        fddd-&gt;wait();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// - retrieve the returned value by the fiber. If the future is not</span></div>
<div class="line">        <span class="comment">//   valid yet, value() will imply wait().</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;fddd = %g\n&quot;</span>, fddd-&gt;value());</div>
<div class="line">        <span class="comment">// In case the return type of the fiber is void, the value() function</span></div>
<div class="line">        <span class="comment">// is not available.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if __cplusplus &gt;= 201103L</span></div>
<div class="line">        <span class="comment">// Arbitrary fiber argument number example.</span></div>
<div class="line">        <a class="code hl_define" href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a> fiber_ddddi(4, 5, 6, 7);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="afiber_8h_html_ac8d3574f284314abb573cdb5762eaf94"><div class="ttname"><a href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a></div><div class="ttdeci">int main_fiber(int argc, char **argv)</div><div class="ttdef"><b>Definition</b> <a href="main_8cpp_source.html#l00011">main.cpp:11</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_ga121a5e39c7e4138aa09c2ce6ea7e213d"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#ga121a5e39c7e4138aa09c2ce6ea7e213d">zth_async</a></div><div class="ttdeci">#define zth_async</div><div class="ttdoc">Run a function as a new fiber.</div><div class="ttdef"><b>Definition</b> <a href="async_8h_source.html#l00828">async.h:828</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_ga2603bf564dbfe29105402410f898bcde"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#ga2603bf564dbfe29105402410f898bcde">zth_fiber_define</a></div><div class="ttdeci">#define zth_fiber_define(...)</div><div class="ttdoc">Do the definition part of zth_fiber() (to be used in a .cpp file).</div><div class="ttdef"><b>Definition</b> <a href="async_8h_source.html#l00799">async.h:799</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_ga2cc783da6d70609272495ea174b0def2"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a></div><div class="ttdeci">#define zth_fiber(...)</div><div class="ttdoc">Prepare every given function to become a fiber by zth_async.</div><div class="ttdef"><b>Definition</b> <a href="async_8h_source.html#l00806">async.h:806</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_gaa75c9c194e3894b31f044e0e9d3a8c1d"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#gaa75c9c194e3894b31f044e0e9d3a8c1d">zth_fiber_declare</a></div><div class="ttdeci">#define zth_fiber_declare(...)</div><div class="ttdoc">Do the declaration part of zth_fiber() (to be used in an .h file).</div><div class="ttdef"><b>Definition</b> <a href="async_8h_source.html#l00779">async.h:779</a></div></div>
<div class="ttc" id="azth_html"><div class="ttname"><a href="zth.html">zth</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
