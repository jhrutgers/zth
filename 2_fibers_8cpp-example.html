<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zth (libzth): 2_fibers.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zth (libzth)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('2_fibers_8cpp-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">2_fibers.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Fiber creation. This program will print: </p><pre class="fragment">fiber_vv()
fddd is not valid yet
fiber_ddd(3, 4) = 7
fddd = 7
fiber_ddd(1, 2) = 3
fiber_vii(3, 14)
fiber_vi(42)
fiber_vv()
</pre><p> Note that the order of the last four lines is not deterministic.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="zth.html">zth</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// zth_fiber() is used to allow using `async&#39; on a function to start a fiber</span></div><div class="line"><span class="comment">// with the given function as entry point.  zth_fiber() generates some static</span></div><div class="line"><span class="comment">// variables to implement this. So, don&#39;t use zth_fiber() in a header file, as</span></div><div class="line"><span class="comment">// it will result in a linker complaining about multiple symbols. You can split</span></div><div class="line"><span class="comment">// zth_fiber() in two parts: the declaration (zth_fiber_declare()) and</span></div><div class="line"><span class="comment">// definition (zth_fiber_define()), like you do with most functions in headers</span></div><div class="line"><span class="comment">// and source files.</span></div><div class="line"></div><div class="line"><span class="comment">// The same applies in case there is a circular dependency between two function</span></div><div class="line"><span class="comment">// calling each other as a fiber.  In that case, you can forward declare the</span></div><div class="line"><span class="comment">// fiber using zth_fiber_declare(), just like you would do in a header file.</span></div><div class="line"></div><div class="line"><span class="comment">// In case you have a header file that should make fibers visible, declare your</span></div><div class="line"><span class="comment">// function as normal.</span></div><div class="line"><span class="keywordtype">void</span> fiber_vv();</div><div class="line"></div><div class="line"><span class="comment">// Then, use zth_fiber_declare() instead of zth_fiber() to generate everything</span></div><div class="line"><span class="comment">// that is required such that other compilation units can do `async</span></div><div class="line"><span class="comment">// fiber_vv()&#39;.</span></div><div class="line"><a name="a0"></a><a class="code" href="group__zth__api__cpp__fiber.html#gaa75c9c194e3894b31f044e0e9d3a8c1d">zth_fiber_declare</a>(fiber_vv)</div><div class="line"></div><div class="line"><span class="comment">// In one .cpp file, zth_fiber_define() is required to implement the actual</span></div><div class="line"><span class="comment">// fiber creation code.</span></div><div class="line"><a name="a1"></a><a class="code" href="group__zth__api__cpp__fiber.html#ga2603bf564dbfe29105402410f898bcde">zth_fiber_define</a>(fiber_vv)</div><div class="line"></div><div class="line"><span class="comment">// And, of course, you need to implement the function itself in the .cpp file.</span></div><div class="line"><span class="keywordtype">void</span> fiber_vv()</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;fiber_vv()\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// You can use function parameters of any type in the fiber entry function,</span></div><div class="line"><span class="comment">// except for references (like an `int const&amp;&#39; parameter).  In the</span></div><div class="line"><span class="comment">// implementation, the arguments are stored and given to the Fiber object.</span></div><div class="line"><span class="comment">// Reference variables are const, and cannot be reassigned, so this is not</span></div><div class="line"><span class="comment">// possible to save and forward arguments. If you do a pass-by-value, note that</span></div><div class="line"><span class="comment">// the data might be copied multiple times by Zth before ending up in the fiber</span></div><div class="line"><span class="comment">// entry. So, try to avoid to do pass-by-value of large structs (as is always</span></div><div class="line"><span class="comment">// smart to avoid in all C/C++ code).</span></div><div class="line"><span class="keywordtype">void</span> fiber_vi(<span class="keywordtype">int</span> i)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;fiber_vi(%d)\n&quot;</span>, i);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> fiber_vii(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;fiber_vii(%d, %d)\n&quot;</span>, x, y);</div><div class="line">}</div><div class="line"><span class="comment">// zth_fiber_declare(), zth_fiber_define() and zth_fiber() allow a list of</span></div><div class="line"><span class="comment">// functions. This is identical to calling zth_fiber...() on every function</span></div><div class="line"><span class="comment">// separately.</span></div><div class="line"><a name="a2"></a><a class="code" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_vi, fiber_vii)</div><div class="line"></div><div class="line"><span class="comment">// Fibers can return data, like normal functions.</span></div><div class="line"><span class="keywordtype">double</span> fiber_ddd(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b)</div><div class="line">{</div><div class="line">    <span class="keywordtype">double</span> res = a + b;</div><div class="line">    printf(<span class="stringliteral">&quot;fiber_ddd(%g, %g) = %g\n&quot;</span>, a, b, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"><a class="code" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_ddd)</div><div class="line"></div><div class="line"><span class="preprocessor">#if __cplusplus &gt;= 201103L</span></div><div class="line"><span class="comment">// The current implementation for pre-C++11 only support up to three arguments.</span></div><div class="line"><span class="comment">// C++11 and higher support arbitrary number of arguments.</span></div><div class="line"><span class="keywordtype">double</span> fiber_ddddi(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> c, <span class="keywordtype">int</span> d)</div><div class="line">{</div><div class="line">    <span class="keywordtype">double</span> res = a * b + c - d;</div><div class="line">    printf(<span class="stringliteral">&quot;fiber_ddddi(%g, %g, %g, %d) = %g\n&quot;</span>, a, b, c, d, res);</div><div class="line">    <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"><a class="code" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(fiber_ddddi)</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a3"></a><a class="code" href="fiber_8h.html#ae4bac78892423c78df857c97e5806cfa">main_fiber</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div><div class="line">{</div><div class="line">    <span class="comment">// `async&#39; is just like a function call, but its execution is postponed.</span></div><div class="line">    <span class="comment">// Note that the order in which the fibers get initialized or execute is</span></div><div class="line">    <span class="comment">// not defined.</span></div><div class="line">    <a name="a4"></a><a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_vv();</div><div class="line">    <a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_vi(42);</div><div class="line">    <a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_vii(3, 14);</div><div class="line"></div><div class="line">    <span class="comment">// The fiber entry points are still available to be called directly.  So,</span></div><div class="line">    <span class="comment">// the following line just calls fiber_vv() right away. There is no</span></div><div class="line">    <span class="comment">// side-effect on fiber_vv() as being marked as fiber entry point.</span></div><div class="line">    fiber_vv();</div><div class="line"></div><div class="line">    <span class="comment">// fiber_ddd() returns a value. If it would be started as below, the return</span></div><div class="line">    <span class="comment">// value is just lost, just like what would happen if you would call</span></div><div class="line">    <span class="comment">// fiber_ddd() as a normal function without using its return value.</span></div><div class="line">    <a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_ddd(1, 2);</div><div class="line"></div><div class="line">    <span class="comment">// zth_fiber() also defines a &lt;function&gt;_future type, which allows</span></div><div class="line">    <span class="comment">// synchronization between fibers. `async&#39; returns this type.</span></div><div class="line">    fiber_ddd_future fddd = <a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_ddd(3, 4);</div><div class="line"></div><div class="line">    <span class="comment">// Now, fddd is a (smart) pointer to a Future object. fddd is small and can</span></div><div class="line">    <span class="comment">// safely be copied or passed using pass-by-value. It gives a few</span></div><div class="line">    <span class="comment">// interesting functions:</span></div><div class="line">    <span class="comment">// - poll whether the fiber has finished and the future becomes therefore</span></div><div class="line">    <span class="comment">//   valid;</span></div><div class="line">    printf(<span class="stringliteral">&quot;fddd is %s\n&quot;</span>, fddd-&gt;valid() ? <span class="stringliteral">&quot;valid&quot;</span> : <span class="stringliteral">&quot;not valid yet&quot;</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// - suspend the current fiber and wait until the fiber has finished;</span></div><div class="line">    fddd-&gt;wait();</div><div class="line"></div><div class="line">    <span class="comment">// - retrieve the returned value by the fiber. If the future is not valid</span></div><div class="line">    <span class="comment">//   yet, value() will imply wait().</span></div><div class="line">    printf(<span class="stringliteral">&quot;fddd = %g\n&quot;</span>, fddd-&gt;value());</div><div class="line">    <span class="comment">// In case the return type of the fiber is void, the value() function is</span></div><div class="line">    <span class="comment">// not available.</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if __cplusplus &gt;= 201103L</span></div><div class="line">    <span class="comment">// Arbitrary fiber argument number example.</span></div><div class="line">    <a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> fiber_ddddi(4, 5, 6, 7);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
