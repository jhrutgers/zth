<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zth (libzth): fsm.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zth (libzth)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('fsm_8cpp-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">fsm.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Finite-state machine example</p>
<div class="fragment"><div class="line"><span class="comment">// This example does not work on Windows, as Windows does not support poll()ing</span></div>
<div class="line"><span class="comment">// stdin. And the ANSI console might be troubling.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="zth.html">zth</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The easiest way to define a State type would be:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// enum State { init, peek, blink_on, blink_off, red_wait, red, amber, green, end };</span></div>
<div class="line"><span class="comment">// typedef zth::FsmCallback&lt;State, zth::Timestamp&amp;, Input&gt; Fsm_type;</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Now, fsm.state() would return one of the State enum values, which could be</span></div>
<div class="line"><span class="comment">// used like this in the callback function:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// switch(fsm.state()) {</span></div>
<div class="line"><span class="comment">// case init:</span></div>
<div class="line"><span class="comment">//     ...</span></div>
<div class="line"><span class="comment">// case peek:</span></div>
<div class="line"><span class="comment">//     ...</span></div>
<div class="line"><span class="comment">// }</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// For the sake of this example, we choose some other State types.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef NDEBUG</span></div>
<div class="line"><span class="comment">// State description with enums, which is as efficient as strings, but does not</span></div>
<div class="line"><span class="comment">// emit the string names in the final binary.</span></div>
<div class="line"><span class="keyword">struct </span>State {</div>
<div class="line">    <span class="keyword">typedef</span> <span class="keyword">enum</span> { init, <a name="a0"></a><a class="code" href="group__zth__api__cpp__fsm.html#ga6786101aa12b384521001c932e076f10">peek</a>, blink_on, blink_off, red_wait, red, amber, green, <a name="a1"></a><a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">end</a> } type;</div>
<div class="line">};</div>
<div class="line"><span class="comment">// Do provide a str() specialization for this type.</span></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacezth.html">zth</a> { <span class="keyword">template</span> &lt;&gt; cow_string str&lt;State::type&gt;(State::type value) { <span class="keywordflow">return</span> <a name="a2"></a><a class="code" href="namespacezth.html#a3d3d928f0db6f76bfd4d414d5ed2e2e8">str</a>((<span class="keywordtype">int</span>)value); } }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="comment">// Nicely named states, which eases debugging.</span></div>
<div class="line"><span class="keyword">namespace </span>State {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* init = <span class="stringliteral">&quot;init&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* <a class="code" href="group__zth__api__cpp__fsm.html#ga6786101aa12b384521001c932e076f10">peek</a> = <span class="stringliteral">&quot;peek&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* blink_on = <span class="stringliteral">&quot;blink on&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* blink_off = <span class="stringliteral">&quot;blink off&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* red_wait = <span class="stringliteral">&quot;red (wait)&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* red = <span class="stringliteral">&quot;red (ready)&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* amber = <span class="stringliteral">&quot;amber&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* green = <span class="stringliteral">&quot;green&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">end</a> = <span class="stringliteral">&quot;end&quot;</span>;</div>
<div class="line">    <span class="keyword">typedef</span> <span class="keywordtype">char</span> <span class="keyword">const</span>* type;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// There exists an str() specialization for char const*, so we don&#39;t have to define one.</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inputs may be passed to an Fsm, which is recorded and can be processed later</span></div>
<div class="line"><span class="comment">// on.  This way, async input symbols are collected, like the traffic</span></div>
<div class="line"><span class="comment">// generation in the trafficDetect() function below.</span></div>
<div class="line"><span class="keyword">enum</span> Input { traffic };</div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacezth.html">zth</a> { <span class="keyword">template</span> &lt;&gt; cow_string str&lt;Input&gt;(Input value) { <span class="keywordflow">return</span> <a class="code" href="namespacezth.html#a3d3d928f0db6f76bfd4d414d5ed2e2e8">str</a>((<span class="keywordtype">int</span>)value); } }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// As the type of the Fsm is quite complex, and you need it multiple times,</span></div>
<div class="line"><span class="comment">// please to a typedef.</span></div>
<div class="line"><span class="keyword">typedef</span> <a name="_a3"></a><a class="code" href="classzth_1_1_fsm_callback.html">zth::FsmCallback&lt;State::type, zth::Timestamp&amp;, Input&gt;</a> Fsm_type;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is a custom guard function. The Fsm template is deducted, but is</span></div>
<div class="line"><span class="comment">// effectively Fsm_type.</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fsm&gt;</div>
<div class="line"><span class="keyword">static</span> <a name="_a4"></a><a class="code" href="classzth_1_1_time_interval.html">zth::TimeInterval</a> tooLongGreen(Fsm&amp; fsm) { <span class="keywordflow">return</span> <a class="code" href="classzth_1_1_time_interval.html">zth::TimeInterval</a>(10) - (<a name="a5"></a><a class="code" href="classzth_1_1_timestamp.html#a0eb8e53a58a414abf6e44a83bb4dc133">zth::Timestamp::now</a>() - fsm.callbackArg()); }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is the description of the state machine.  States, guards, and</span></div>
<div class="line"><span class="comment">// transitions are constant; it is impossible to define them dynamically.  The</span></div>
<div class="line"><span class="comment">// desc object is to be processed during initialization. Don&#39;t make it const.</span></div>
<div class="line"><span class="keyword">static</span> Fsm_type::Description desc = {</div>
<div class="line">    <span class="comment">// The structure is as follows:</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// State where we are in,</span></div>
<div class="line">    <span class="comment">//    guard to check,                                           state to go to when the guard is valid</span></div>
<div class="line">    <span class="comment">//    another guard to check if the first one is not valid,     state to go to if this guard is valid</span></div>
<div class="line">    <span class="comment">//    ...many other guard/state pairs...</span></div>
<div class="line">    <span class="comment">//    zth::guards::end to indicate the end of the guard list</span></div>
<div class="line">    <span class="comment">// Another state</span></div>
<div class="line">    <span class="comment">//    ...</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Guards are processed in order (top-down).  If no guard is valid, the Fsm</span></div>
<div class="line">    <span class="comment">// will remain in the current state.  The Fsm will reevaluate the guards as</span></div>
<div class="line">    <span class="comment">// many times as appropriate.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// States mentioned after the guards must exist within this description</span></div>
<div class="line">    <span class="comment">// list.  However, it does not matter where in the list the state is.</span></div>
<div class="line">    <span class="comment">// States can only be in the list once, but there can be many transitions</span></div>
<div class="line">    <span class="comment">// pointing to the same state.</span></div>
<div class="line"> </div>
<div class="line">    State::init,</div>
<div class="line">        <a name="a6"></a><a class="code" href="group__zth__api__cpp__fsm.html#ga4cc318fcef78da50252ecf3afb1c5f02">zth::guards::always</a>,            State::blink_on,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    <a class="code" href="group__zth__api__cpp__fsm.html#ga6786101aa12b384521001c932e076f10">State::peek</a>,</div>
<div class="line">        zth::guards::peek&lt;Fsm_type,traffic&gt;,    State::amber,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga4cc318fcef78da50252ecf3afb1c5f02">zth::guards::always</a>,            State::blink_on,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::blink_on,</div>
<div class="line">        zth::guards::timeout_s&lt;1&gt;,      State::blink_off,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::blink_off,</div>
<div class="line">        zth::guards::timeout_s&lt;1&gt;,      <a class="code" href="group__zth__api__cpp__fsm.html#ga6786101aa12b384521001c932e076f10">State::peek</a>,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::red_wait,</div>
<div class="line">        zth::guards::timeout_s&lt;2&gt;,      State::red,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::red,</div>
<div class="line">        zth::guards::input&lt;Fsm_type,traffic&gt;,   State::green,</div>
<div class="line">        zth::guards::timeout_s&lt;10&gt;,     State::blink_off,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::green,</div>
<div class="line">        <span class="comment">// Stay at green as long as there is traffic, but limited to some maximum time.</span></div>
<div class="line">        tooLongGreen,               State::amber,</div>
<div class="line">        zth::guards::input&lt;Fsm_type,traffic&gt;,   State::green,</div>
<div class="line">        zth::guards::timeout_s&lt;3&gt;,      State::amber,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    State::amber,</div>
<div class="line">        zth::guards::timeout_s&lt;2&gt;,      State::red_wait,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The description must end with a state without guards:</span></div>
<div class="line">    <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">State::end</a>,</div>
<div class="line">        <a class="code" href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a>,</div>
<div class="line">    <span class="comment">// (Note that this state cannot be reached in this example, but that does</span></div>
<div class="line">    <span class="comment">// not matter.) This is the marker that there are no more states after</span></div>
<div class="line">    <span class="comment">// this.  Anything below here, will be ignored.</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is the callback function that is invoked when the Fsm changes something</span></div>
<div class="line"><span class="comment">// to the state.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cb(Fsm_type&amp; fsm, <a name="_a7"></a><a class="code" href="classzth_1_1_timestamp.html">zth::Timestamp</a>&amp; green)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>(fsm.state() == State::red &amp;&amp; fsm.exit() &amp;&amp; fsm.next() == State::green)</div>
<div class="line">        green = <a class="code" href="classzth_1_1_timestamp.html#a0eb8e53a58a414abf6e44a83bb4dc133">zth::Timestamp::now</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(!fsm.entry())</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// I know, switch(fsm.state()) is nicer, but then the State must be some integral type...</span></div>
<div class="line">    <span class="keywordflow">if</span>(fsm.state() == State::init) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\x1b[0m ________ \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;/        \\\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\\________/\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;    ||    \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;    ||    \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;    ||    \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;    ||    \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nPress enter to generate traffic.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>(!<a name="a8"></a><a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\x1b[17A\x1b[s&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fsm.state() == State::blink_on || fsm.state() == State::amber) {</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[u&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot; ________ \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;/        \\\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[33m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[33m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\\________/\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[11A&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fsm.state() == State::red_wait) {</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[u&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot; ________ \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;/        \\\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[31;1m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[31;1m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\\________/\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[11A&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fsm.state() == State::green) {</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[u&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot; ________ \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;/        \\\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[32;1m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   \x1b[32;1m00\x1b[0m   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\\________/\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[11A&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fsm.state() == State::blink_off) {</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[u&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot; ________ \n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;/        \\\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|        |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;|   ..   |\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\\________/\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a>(EnableDebugPrint))</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n\x1b[11A&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    fflush(NULL);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Something to be passed to the callback function.</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="classzth_1_1_timestamp.html">zth::Timestamp</a> green;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Here we actually create the Fsm.</span></div>
<div class="line"><span class="comment">// The description has to be compiled in order to be used by a Fsm.</span></div>
<div class="line"><span class="comment">// You could create multiple Fsms using the same description, but it has to be compiled only once.</span></div>
<div class="line"><span class="comment">// Therefore, create one compiler for one description.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">typename</span> Fsm_type::Compiler compiler(desc);</div>
<div class="line"><span class="keyword">static</span> Fsm_type fsm(compiler, &amp;cb, green);</div>
<div class="line"><span class="comment">//static Fsm_type fsm2(compiler, &amp;cb, green2); // This is OK.</span></div>
<div class="line"><span class="comment">//static Fsm_type fsm3(compiler, &amp;cb, green3); // This is OK.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// If you would only create one Fsm for the description, you can pass it directly to the Fsm instance.</span></div>
<div class="line"><span class="comment">//static Fsm_type fsm(desc, &amp;cb, green);</span></div>
<div class="line"><span class="comment">//static Fsm_type fsm2(desc, &amp;cb, green); // This is not OK, as desc will now be compiled multiple times.</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> trafficDetect()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buf = 0;</div>
<div class="line">    <span class="keywordflow">while</span>(<a name="a9"></a><a class="code" href="group__zth__api__cpp__io.html#ga1eee4d1bd134d3b8477197f8aa08d5de">zth::io::read</a>(0, &amp;buf, 1) &gt; 0)</div>
<div class="line">        fsm.input(traffic);</div>
<div class="line">}</div>
<div class="line"><a name="a10"></a><a class="code" href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a>(trafficDetect)</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a name="a11"></a><a class="code" href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a>(<span class="keywordtype">int</span> <span class="comment">/*argc*/</span>, <span class="keywordtype">char</span>** <span class="comment">/*argv*/</span>)</div>
<div class="line">{</div>
<div class="line">    <a name="a12"></a><a class="code" href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a> trafficDetect();</div>
<div class="line">    <span class="comment">// Run the Fsm, until it hits a final state (but there is none in this example).</span></div>
<div class="line">    fsm.run();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__zth__api__cpp__config_html_ga05849634b61cc2af248e038ee2cbea39"><div class="ttname"><a href="group__zth__api__cpp__config.html#ga05849634b61cc2af248e038ee2cbea39">zth_config</a></div><div class="ttdeci">#define zth_config(name)</div><div class="ttdoc">Checks if the given zth::Config field is enabled.</div><div class="ttdef"><b>Definition:</b> <a href="config_8h_source.html#l00051">config.h:51</a></div></div>
<div class="ttc" id="anamespacezth_html_a3d3d928f0db6f76bfd4d414d5ed2e2e8"><div class="ttname"><a href="namespacezth.html#a3d3d928f0db6f76bfd4d414d5ed2e2e8">zth::str</a></div><div class="ttdeci">cow_string str(T value)</div><div class="ttdoc">Returns an zth::string() representation of the given value.</div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00351">util.h:351</a></div></div>
<div class="ttc" id="aclasszth_1_1_timestamp_html_a0eb8e53a58a414abf6e44a83bb4dc133"><div class="ttname"><a href="classzth_1_1_timestamp.html#a0eb8e53a58a414abf6e44a83bb4dc133">zth::Timestamp::now</a></div><div class="ttdeci">static Timestamp now()</div><div class="ttdef"><b>Definition:</b> <a href="time_8h_source.html#l00361">time.h:361</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__io_html_ga1eee4d1bd134d3b8477197f8aa08d5de"><div class="ttname"><a href="group__zth__api__cpp__io.html#ga1eee4d1bd134d3b8477197f8aa08d5de">zth::io::read</a></div><div class="ttdeci">ssize_t read(int fd, void *buf, size_t count)</div><div class="ttdoc">Like normal read(), but forwards the poll() to the zth::Waiter in case it would block.</div><div class="ttdef"><b>Definition:</b> <a href="io_8cpp_source.html#l00035">io.cpp:35</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_gada84521eeb4bb9ac422d21429806aff3"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#gada84521eeb4bb9ac422d21429806aff3">async</a></div><div class="ttdeci">#define async</div><div class="ttdoc">Run a function as a new fiber.</div><div class="ttdef"><b>Definition:</b> <a href="async_8h_source.html#l00517">async.h:517</a></div></div>
<div class="ttc" id="anamespacezth_html"><div class="ttname"><a href="namespacezth.html">zth</a></div><div class="ttdef"><b>Definition:</b> <a href="allocator_8h_source.html#l00032">allocator.h:32</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fsm_html_ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc"><div class="ttname"><a href="group__zth__api__cpp__fsm.html#ga7794029333471a5b06bcf2fa09de9ec5ab3346a445955528087930465ba0f93dc">zth::guards::end</a></div><div class="ttdeci">@ end</div><div class="ttdoc">End-of-guard-list marker.</div><div class="ttdef"><b>Definition:</b> <a href="fsm_8h_source.html#l00043">fsm.h:43</a></div></div>
<div class="ttc" id="aclasszth_1_1_time_interval_html"><div class="ttname"><a href="classzth_1_1_time_interval.html">zth::TimeInterval</a></div><div class="ttdoc">Convenient wrapper around struct timespec that contains a time interval.</div><div class="ttdef"><b>Definition:</b> <a href="time_8h_source.html#l00058">time.h:58</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fiber_html_ga2cc783da6d70609272495ea174b0def2"><div class="ttname"><a href="group__zth__api__cpp__fiber.html#ga2cc783da6d70609272495ea174b0def2">zth_fiber</a></div><div class="ttdeci">#define zth_fiber(...)</div><div class="ttdoc">Prepare every given function to become a fiber by async.</div><div class="ttdef"><b>Definition:</b> <a href="async_8h_source.html#l00496">async.h:496</a></div></div>
<div class="ttc" id="aclasszth_1_1_timestamp_html"><div class="ttname"><a href="classzth_1_1_timestamp.html">zth::Timestamp</a></div><div class="ttdoc">Convenient wrapper around struct timespec that contains an absolute timestamp.</div><div class="ttdef"><b>Definition:</b> <a href="time_8h_source.html#l00342">time.h:342</a></div></div>
<div class="ttc" id="afiber_8h_html_ac8d3574f284314abb573cdb5762eaf94"><div class="ttname"><a href="fiber_8h.html#ac8d3574f284314abb573cdb5762eaf94">main_fiber</a></div><div class="ttdeci">int main_fiber(int argc, char **argv)</div></div>
<div class="ttc" id="agroup__zth__api__cpp__fsm_html_ga6786101aa12b384521001c932e076f10"><div class="ttname"><a href="group__zth__api__cpp__fsm.html#ga6786101aa12b384521001c932e076f10">zth::guards::peek</a></div><div class="ttdeci">TimeInterval peek(Fsm &amp;fsm)</div><div class="ttdoc">A guard that is true when the given input has been set.</div><div class="ttdef"><b>Definition:</b> <a href="fsm_8h_source.html#l00074">fsm.h:74</a></div></div>
<div class="ttc" id="agroup__zth__api__cpp__fsm_html_ga4cc318fcef78da50252ecf3afb1c5f02"><div class="ttname"><a href="group__zth__api__cpp__fsm.html#ga4cc318fcef78da50252ecf3afb1c5f02">zth::guards::always</a></div><div class="ttdeci">TimeInterval always(Fsm &amp;fsm)</div><div class="ttdoc">A guard that is always true.</div><div class="ttdef"><b>Definition:</b> <a href="fsm_8h_source.html#l00049">fsm.h:49</a></div></div>
<div class="ttc" id="aclasszth_1_1_fsm_callback_html"><div class="ttname"><a href="classzth_1_1_fsm_callback.html">zth::FsmCallback</a></div><div class="ttdef"><b>Definition:</b> <a href="fsm_8h_source.html#l00630">fsm.h:630</a></div></div>
<div class="ttc" id="azth_html"><div class="ttname"><a href="zth.html">zth</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
